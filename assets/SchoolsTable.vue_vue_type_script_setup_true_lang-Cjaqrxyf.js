import{s as A,a as O}from"./index-BxVfWoVs.js";import{s as j,a as H}from"./index-U6bxdMDU.js";import{s as G}from"./index-D-Li2oDx.js";import{$ as K,e as q,f as J,r as L,o as y,i as Q,w as d,a as S,c as v,t as c,j as W,m as U,k as r,G as k,h as I,y as X,b2 as Y,l as Z}from"./index-BXslawiU.js";import{x as T}from"./xlsx.min-BwnNBxlO.js";import{S as ee}from"./schoolApi-DHommu5t.js";import{m as te}from"./mapClassFromDto-BHXsJaNm.js";let R=[],M=[];async function se(_,p,g,f){const s=new URLSearchParams;return p.forEach(h=>s.append("route_ids",h.toString())),g.forEach(h=>s.append("lesson_type",h)),s.append("progress",f.toString()),K.get(`/v2/school/${_}/progress`,{params:s})}async function oe(_,p,g,f){try{const{data:s}=await ee.getSchoolClassesById(_);R=(s==null?void 0:s.map(te))??[]}catch(s){console.error("Error load classes:",s)}try{const{data:s}=await se(_,p,g,f);M=s}catch(s){console.error("Error get school progress:",s)}}const o=(_,p=!1,g=!0,f)=>({v:_,s:{font:{bold:p,name:"Arial",sz:10},alignment:{vertical:"center",horizontal:g?"center":"left",wrapText:!0},fill:f?{fgColor:{rgb:f}}:void 0,border:{top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}}}});async function re(_,p,g,f){const s=T.utils.book_new(),h=[],E=[],V=new Date().toLocaleDateString("ru-RU");h.push([o(V,!0,!1)]),h.push([]);for(const t of _){if(await oe(t.id,p,g,f),R.length===0)continue;const a=h.length,b={},D={};h.push([o(t.title_en,!0,!1)]),p.forEach(l=>{const i=M.filter(u=>u.route_id===l);D[l]=i.length>0?i[0].route_name:`Курс ID ${l}`;const m=[...new Set(i.map(u=>u.level_name))].sort((u,C)=>u.localeCompare(C,void 0,{numeric:!0}));b[l]=m.length>0?m:["Нет данных"]});const $=[o(""),o("Зарегистрировались",!0)],x=[o("Класс",!0),o("")];let n=2;p.forEach(l=>{const i=b[l],m=i.length;if($.push(o(D[l],!0,!0,"D9EAD3")),m>1){for(let u=1;u<m;u++)$.push(o(""));E.push({s:{r:a+1,c:n},e:{r:a+1,c:n+m-1}})}i.forEach(u=>x.push(o(u,!0,!0,"FCE5CD"))),n+=m}),h.push($,x);const F=[];R.forEach(l=>{const i=[o(l.name),o(l.studentCount,!1,!0)];p.forEach(m=>{b[m].forEach(u=>{const C=M.find(B=>B.class_id===l.id&&B.route_id===m&&B.level_name===u);i.push(o(C?C.completed_count:0,!1,!0))})}),F.push(i),h.push(i)});const e=R.reduce((l,i)=>l+(i.studentCount||0),0),N=[o("Общее",!0),o(e,!0,!0)],P=[o(""),o("")];let z=2;p.forEach(l=>{b[l].forEach(()=>{const i=F.reduce((u,C)=>u+(C[z].v||0),0);N.push(o(i,!0,!0,"FFF2CC"));const m=e>0?(i/e*100).toFixed(2)+"%":"0%";P.push(o(m,!0,!0)),z++})}),h.push(N,P,[])}const w=T.utils.aoa_to_sheet(h);w["!merges"]=E,w["!cols"]=[{wch:30},{wch:20}];for(let t=2;t<50;t++)w["!cols"].push({wch:15});T.utils.book_append_sheet(s,w,"Отчет"),T.writeFile(s,`Отчет_${new Date().toLocaleDateString("ru-RU")}_${new Date().toLocaleTimeString("ru-RU")}.xlsx`)}const ae={class:"flex items-center"},ne={class:"flex-grow flex gap-2 items-center"},le={key:0,class:"text-2xl"},ie={key:0},ce={key:1},ue={key:2},de={class:"w-44"},pe={key:0,class:"w-40"},he={key:1,class:"w-40"},me={key:0,class:"w-40"},fe={key:1,class:"w-40"},$e=q({__name:"SchoolsTable",props:{schools:{},loading:{type:Boolean}},setup(_){const p=_,{locale:g}=J(),f=L(),s=L();(()=>{s.value={global:{value:null,matchMode:Y.CONTAINS}}})();const E=()=>{f.value.exportCSV()},V=()=>{re(p.schools,[11,1,6,7],["learn","project"],80)};function w(t){const a=new Date,b=new Date(t);a.setHours(0,0,0,0),b.setHours(0,0,0,0);const D=b.getTime()-a.getTime();return Math.ceil(D/(1e3*60*60*24))}return(t,a)=>{const b=Z,D=j,$=G,x=H,n=A,F=O;return y(),Q(F,{ref_key:"dt",ref:f,filters:s.value,"onUpdate:filters":a[1]||(a[1]=e=>s.value=e),value:t.schools,dataKey:"id",loading:t.loading,scrollable:"",globalFilterFields:["id","title_en","country","address","manager_email"],paginator:"",rows:10,rowsPerPageOptions:[5,10,25],class:"rounded-md overflow-hidden w-full"},{header:d(()=>[S("div",ae,[S("div",ne,[t.schools?(y(),v("div",le,c(t.$t("schools"))+" - "+c(t.schools.length),1)):W("",!0)]),U(t.$slots,"header-extra"),r(b,{label:t.$t("export"),icon:"pi pi-upload",severity:"info",variant:"outlined",class:"mr-2",onClick:E},null,8,["label"]),r(b,{label:"Export progress",icon:"pi pi-upload",severity:"info",variant:"outlined",class:"mr-2",onClick:V}),r(x,null,{default:d(()=>[r(D,null,{default:d(()=>a[2]||(a[2]=[S("i",{class:"pi pi-search"},null,-1)])),_:1}),r($,{modelValue:s.value.global.value,"onUpdate:modelValue":a[0]||(a[0]=e=>s.value.global.value=e),placeholder:t.$t("pages.teacher.search")},null,8,["modelValue","placeholder"])]),_:1})])]),empty:d(()=>a[3]||(a[3]=[k(" No schools found. ")])),loading:d(()=>a[4]||(a[4]=[k(" Loading schools data. Please wait. ")])),default:d(()=>[r(n,{field:"id",header:"ID",sortable:""}),r(n,{field:"title_en",header:t.$t("name"),sortable:""},{body:d(({data:e})=>[I(g)==="en"?(y(),v("span",ie,c(e.title_en),1)):I(g)==="kk"?(y(),v("span",ce,c(e.title_kz),1)):(y(),v("span",ue,c(e.title_ru),1))]),_:1},8,["header"]),r(n,{field:"country",header:t.$t("pages.settings.country"),sortable:""},null,8,["header"]),r(n,{field:"address",header:t.$t("pages.school.address"),sortable:""},null,8,["header"]),r(n,{field:"manager_email",header:t.$t("managerEmail"),sortable:""},null,8,["header"]),r(n,{field:"num_current_classes",header:t.$t("pages.teacher.classes"),sortable:""},{body:d(({data:e})=>[k(c(e.num_current_classes)+" / "+c(e.num_max_classes),1)]),_:1},8,["header"]),r(n,{field:"num_current_teachers",header:t.$t("pages.school.teachers"),sortable:""},{body:d(({data:e})=>[k(c(e.num_current_teachers)+" / "+c(e.num_max_teachers),1)]),_:1},8,["header"]),r(n,{field:"num_current_students",header:t.$t("pages.teacher.students"),sortable:""},{body:d(({data:e})=>[k(c(e.num_current_students)+" / "+c(e.num_max_students),1)]),_:1},8,["header"]),r(n,{field:"created_time",header:t.$t("createdTime"),sortable:""},{body:d(({data:e})=>[S("div",de,c(e.created_time.split("T")[0]+" "+e.created_time.split(".")[0].split("T")[1]),1)]),_:1},8,["header"]),r(n,{field:"subscription_start",header:t.$t("subscriptionStart"),sortable:""},{body:d(({data:e})=>[e.subscription_start?(y(),v("div",pe,c(e.subscription_start.split("T")[0]),1)):(y(),v("div",he,"-"))]),_:1},8,["header"]),r(n,{field:"subscription_end",header:t.$t("subscriptionEnd"),sortable:""},{body:d(({data:e})=>[e.subscription_end?(y(),v("div",me,[S("span",{class:X({"text-red-500":w(new Date(e.subscription_end))<0,"text-orange-500":w(new Date(e.subscription_end))>=0&&w(new Date(e.subscription_end))<10})},c(e.subscription_end.split("T")[0])+" (left "+c(w(new Date(e.subscription_end)))+") ",3)])):(y(),v("div",fe,"-"))]),_:1},8,["header"]),r(n,{frozen:!0,alignFrozen:"right",exportable:!1},{body:d(({data:e})=>[U(t.$slots,"actions",{row:e})]),_:3})]),_:3},8,["filters","value","loading"])}}});export{$e as _};
