import{s as G,a as K}from"./index-D24MRCgv.js";import{s as Y,a as J}from"./index-CQCkvxda.js";import{s as Q}from"./index-B3NttIqY.js";import{e as E,r as b,o as D,i as U,w as p,a as m,c as W,t as _,j as X,m as B,k as n,G as L,b2 as Z,l as A,a4 as ee,f as se,P as le,C as ae,h as oe,R as te}from"./index-8eYd0-Co.js";import{s as ne}from"./index-c_rbGUP2.js";import{s as re}from"./index-DSx-p37b.js";import{u as k,w as ie}from"./xlsx-DjuO7_Ju.js";import{R as de}from"./routeApi-C9o8WR_b.js";import{m as pe}from"./mapRouteFromDto-C1VVcbzq.js";import{A as ce}from"./lessonType-DG-bLtoJ.js";import{C as R}from"./classApi-Cg8-sV8L.js";import{m as ue}from"./mapStudentFromDto-D4MSietx.js";const me={class:"flex items-center"},fe={class:"flex-grow flex gap-2 items-center"},ve={key:0,class:"text-2xl"},Me=E({__name:"ClassesTable",props:{classes:{},loading:{type:Boolean}},setup(V){const c=b(),u=b();(()=>{u.value={global:{value:null,matchMode:Z.CONTAINS}}})();const y=()=>{c.value.exportCSV()};return(l,r)=>{const $=A,f=Y,x=Q,I=J,v=G,N=K;return D(),U(N,{ref_key:"dt",ref:c,filters:u.value,"onUpdate:filters":r[1]||(r[1]=e=>u.value=e),value:l.classes,dataKey:"id",loading:l.loading,scrollable:"",globalFilterFields:["name","creatorName","creatorEmail","studentCount"],paginator:"",rows:10,rowsPerPageOptions:[5,10,25],class:"rounded-md overflow-hidden w-full"},{header:p(()=>[m("div",me,[m("div",fe,[l.classes?(D(),W("div",ve,_(l.$t("pages.teacher.classes"))+" - "+_(l.classes.length),1)):X("",!0)]),B(l.$slots,"header-extra"),n($,{label:l.$t("export"),icon:"pi pi-upload",severity:"info",variant:"outlined",class:"mr-2",onClick:y},null,8,["label"]),n(I,null,{default:p(()=>[n(f,null,{default:p(()=>r[2]||(r[2]=[m("i",{class:"pi pi-search"},null,-1)])),_:1}),n(x,{modelValue:u.value.global.value,"onUpdate:modelValue":r[0]||(r[0]=e=>u.value.global.value=e),placeholder:l.$t("pages.teacher.search")},null,8,["modelValue","placeholder"])]),_:1})])]),empty:p(()=>[L(_(l.$t("pages.teacher.noClassesFound")),1)]),loading:p(()=>[L(_(l.$t("pages.teacher.loadingClasses")),1)]),default:p(()=>[n(v,{field:"id",header:"ID",sortable:""}),n(v,{field:"name",header:l.$t("pages.teacher.name"),sortable:""},null,8,["header"]),n(v,{field:"creatorName",header:l.$t("pages.teacher.classTeacher"),sortable:""},{body:p(({data:e})=>[m("div",null,_(`${e.creatorName||e.creatorEmail}`),1)]),_:1},8,["header"]),n(v,{field:"studentCount",header:l.$t("pages.teacher.students"),sortable:""},null,8,["header"]),n(v,{frozen:!0,alignFrozen:"right",exportable:!1},{body:p(({data:e})=>[B(l.$slots,"actions",{row:e})]),_:3})]),_:3},8,["filters","value","loading"])}}}),ge={class:"flex flex-col gap-1"},he={class:"flex flex-col gap-3"},be={class:"flex gap-2 items-center justify-between w-full"},$e={class:"flex-grow"},_e={class:"flex gap-2 justify-end"},Pe=E({__name:"ExportProgressDialog",props:ee({classes:{},schoolName:{}},{modelValue:{type:Boolean,required:!0},modelModifiers:{}}),emits:["update:modelValue"],setup(V){const{t:c}=se(),u=le(V,"modelValue"),S=V,y=b([]),l=b([]),r=b(["learn","practice"]),$=b([]),f=b(!1);async function x(){try{const{data:e}=await de.getRoutes();y.value=(e==null?void 0:e.map(pe))??[]}catch(e){console.log(e)}}ae(async()=>{await x()});async function I(){f.value=!0;const e=new Set(l.value),o=new Set(r.value),i=y.value.filter(a=>e.has(a.id)).map(a=>({...a,lessons:a.lessons.filter(g=>o.has(g.lessonType))})),t=[];for(const a of i)for(const g of a.levels)for(const h of a.lessons.filter(d=>d.levelId===g.id))h.stage=="published"&&t.push({routeId:a.id,levelId:g.id,lessonId:h.id,lessonType:h.lessonType,lessonName:h.name});const w=t.map(a=>`${a.lessonName} (${a.lessonId})`),T=[c("pages.teacher.name"),c("pages.settings.class"),...w,c("pages.teacher.xp")],s=[];for(const a of S.classes){if(!$.value.includes(a.id)||a.studentCount==0)continue;let g;try{const{data:d}=await R.getClassStudents(a.id);g=(d==null?void 0:d.map(ue))??[]}catch(d){alert(d),f.value=!1;return}const h=await v(a.id);if(h==null){f.value=!1;return}s.push(...g.map(d=>{const C={};C[c("pages.teacher.name")]=d.name.length>0?d.name:d.email,C[c("pages.settings.class")]=a.name;let M=0;for(const[H,q]of t.entries()){const P=N(h,d.id,q.lessonId);C[w[H]]=`${P}%`,P>=100&&(M+=1)}return C[c("pages.teacher.xp")]=`${M}/${t.length}`,C}))}const O=[T,...s.map(a=>Object.values(a))],j=k.aoa_to_sheet(O),F=k.book_new();k.book_append_sheet(F,j);const z=`${S.schoolName} (${new Date().toISOString().split("T")[0]}).xlsx`;ie(F,z),f.value=!1}async function v(e){try{const{data:o}=await R.getClassStudentsProgress(e,l.value,r.value),i={};for(const t of o.progress_data??[])i[t.student_id]||(i[t.student_id]={}),i[t.student_id][t.lesson_id]=t.completed?100:t.student_progress;return i}catch(o){console.log(o)}}function N(e,o,i){var t;return((t=e[o])==null?void 0:t[i])??0}return(e,o)=>{const i=re,t=ne,w=A,T=te;return D(),U(T,{visible:u.value,"onUpdate:visible":o[4]||(o[4]=s=>u.value=s),modal:"",draggable:!1,class:"m-4 max-w-md",header:e.$t("exportProgress")},{default:p(()=>[m("div",ge,[m("div",he,[n(i,{class:"min-w-[220px]",options:y.value.map(s=>({label:s.name,value:s.id})),optionLabel:"label",invalid:l.value.length===0,optionValue:"value",display:"chip",modelValue:l.value,"onUpdate:modelValue":o[0]||(o[0]=s=>l.value=s),placeholder:e.$t("courses")},null,8,["options","invalid","modelValue","placeholder"]),n(i,{class:"min-w-[220px]",options:oe(ce),optionLabel:s=>s,optionValue:s=>s,display:"chip",modelValue:r.value,"onUpdate:modelValue":o[1]||(o[1]=s=>r.value=s),placeholder:e.$t("lessonType"),invalid:r.value.length===0},{option:p(({option:s})=>[m("div",be,[m("div",$e,_(s.charAt(0).toUpperCase()+s.slice(1)),1)])]),_:1},8,["options","optionLabel","optionValue","modelValue","placeholder","invalid"]),n(i,{class:"min-w-[220px]",options:e.classes.map(s=>({label:s.name,value:s.id})),optionLabel:"label",invalid:$.value.length===0,optionValue:"value",display:"chip",modelValue:$.value,"onUpdate:modelValue":o[2]||(o[2]=s=>$.value=s),placeholder:e.$t("pages.teacher.classes")},null,8,["options","invalid","modelValue","placeholder"])]),n(t),m("div",_e,[n(w,{label:e.$t("pages.teacher.cancel"),severity:"secondary",onClick:o[3]||(o[3]=s=>u.value=!1)},null,8,["label"]),n(w,{label:e.$t("export"),loading:f.value,disabled:f.value,onClick:I},null,8,["label","loading","disabled"])])])]),_:1},8,["visible","header"])}}});export{Me as _,Pe as a};
