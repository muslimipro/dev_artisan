import{T as Fe}from"./index-rk4YK_vv.js";import{s as Ne}from"./index-_3UFzAIg.js";import{s as De}from"./index-DjQFJnoV.js";import{B as Le,s as ie,e as Pe,u as ze,$ as Re,a as je,r as u,g as Be,f as Ge,b as N,h as Ae,D as Ue,o as i,q as w,w as r,k as l,t as d,i as o,l as H,j as O,v as D,p as Y,c as f,n as L,F as b,a2 as K,C as Me,x as Ee,aN as qe,y as He,I as Oe}from"./index-DrRumHoQ.js";import{s as Ye,a as Ke}from"./index-kUo8DtFK.js";import{a as Je,b as Qe}from"./index-BffwYWps.js";import{s as We}from"./index-C48zRprc.js";import{s as Xe}from"./index-B4cNVyat.js";import{R as Ze,m as et}from"./mapRouteFromDto-RnrWjANF.js";import{A as re}from"./lessonType-v5Tmr0TL.js";import{C as x,m as tt}from"./mapClassFromDto-ByaLzb_u.js";import{m as st}from"./mapStudentFromDto-D4MSietx.js";import{S as at}from"./schoolApi-BJti6mJG.js";import"./index-BwPWftOE.js";import"./index-BUc4_QyG.js";import"./index-D-t7ilJh.js";import"./index-BzRn24Gq.js";import"./index-D_MVTTrq.js";import"./index-CfS82_u7.js";import"./index-C7Lnsry6.js";import"./index-BMovUAwj.js";import"./index-CTHCdsbo.js";import"./mapLessonFromDto-DxMZVnwf.js";import"./mapUnitFromDto-BRBO9875.js";import"./transformUnitDtosToPages-CGD_PO48.js";var ot=Le.extend({name:"columngroup"}),lt={name:"BaseColumnGroup",extends:ie,props:{type:{type:String,default:null}},style:ot,provide:function(){return{$pcColumnGroup:this,$parentInstance:this}}},nt={name:"ColumnGroup",extends:lt,inheritAttrs:!1,inject:["$columnGroups"],mounted:function(){var n;(n=this.$columnGroups)===null||n===void 0||n.add(this.$)},unmounted:function(){var n;(n=this.$columnGroups)===null||n===void 0||n.delete(this.$)},render:function(){return null}},rt={name:"Row",extends:ie,inject:["$rows"],mounted:function(){var n;(n=this.$rows)===null||n===void 0||n.add(this.$)},unmounted:function(){var n;(n=this.$rows)===null||n===void 0||n.delete(this.$)},render:function(){return null}};const it={class:"flex flex-col items-start px-8 pb-4 gap-4"},ut={class:"flex items-center justify-between gap-2 w-full"},dt={class:"flex flex-col gap-2"},ct={class:"text-3xl"},pt={class:"text-sm"},mt={class:"flex items-center self-end"},ft={class:"text-xl"},vt={class:"text-gray-500"},gt={class:"flex items-center"},ht={class:"flex-grow flex gap-2 items-center"},yt={class:"flex gap-2 items-center justify-between w-full"},_t={class:"flex-grow"},bt={class:"w-full text-center"},$t={class:"w-full text-center"},wt={class:"flex flex-col"},xt={class:"text-[10px] text-gray-500"},Ct={key:0,class:"pi pi-check",style:{"font-size":"10px"}},St={key:1,class:"pi pi-ellipsis-h",style:{"font-size":"10px"}},Tt={class:"text-right"},kt={class:"flex justify-center text-[124px]"},It={class:"flex justify-between items-center mb-8"},Vt={class:"flex justify-end gap-2"},ss=Pe({__name:"ClassPage",setup($){const n=ze(),R=Re(),y=Me(),ue=Ee(),{t:c}=je(),de=u(),S=u();(()=>{S.value={global:{value:null,matchMode:qe.CONTAINS}}})();const ce=Be(),{userInfo:j}=Ge(ce),B=u(!1),C=u(null),T=u([]),v=u([]),g=u(["learn","practice"]),k=N(()=>{if(v.value.length==0||g.value.length==0)return[];const e=new Set(v.value),t=v.value.length>0,a=new Set(g.value),m=g.value.length>0&&g.value.length<re.length;return T.value.filter(_=>!t||e.has(_.id)).map(_=>({..._,lessons:_.lessons.filter(M=>!m||a.has(M.lessonType))}))}),J=N(()=>{const e={};for(const t of k.value)e[t.id]=t.lessons.length;return e}),Q=N(()=>{const e={};for(const t of k.value){e[t.id]={};for(const a of t.levels)e[t.id][a.id]=0;for(const a of t.lessons)e[t.id][a.levelId]=(e[t.id][a.levelId]??0)+1}return e}),P=N(()=>{const e=[];for(const t of k.value)for(const a of t.levels)for(const m of t.lessons.filter(_=>_.levelId===a.id))e.push({routeId:t.id,levelId:a.id,lessonId:m.id,lessonType:m.lessonType,lessonName:m.name});return e}),pe=N(()=>P.value.length);function me(e){let t=0;for(const a of P.value)I(e,a.lessonId)>=100&&(t+=1);return t}function W(e){return e==="learn"?"bg-primary400":e==="practice"?"bg-purple400":e==="module"?"bg-warning400":"bg-blue400"}async function G(){var e;try{const{data:t}=await x.getClass(Number(y.params.id));C.value=tt(t),((e=j.value)==null?void 0:e.user_type)=="school_manager"&&(await Ce(),F.value=U.value.find(a=>{var m;return a.teacher_id==((m=C.value)==null?void 0:m.creator)})??null)}catch(t){console.log(t)}}async function fe(){try{const{data:e}=await Ze.getRoutes();T.value=(e==null?void 0:e.map(et))??[]}catch(e){console.log(e)}}async function ve(){try{const{data:e}=await x.getClassStudentsProgress(Number(y.params.id),v.value,g.value),t={};for(const a of e.progress_data??[])t[a.student_id]||(t[a.student_id]={}),t[a.student_id][a.lesson_id]=a.student_progress;X.value=t}catch(e){console.log(e)}}const X=u({});function I(e,t){var a;return((a=X.value[e])==null?void 0:a[t])??0}function ge(e){return e>=100?"bg-primary400":e>0?"bg-warning400":"bg-neutral100"}const A=u(!1),Z=u();async function ee(e){try{A.value=!0;const{data:t}=await x.getClassStudents(e);Z.value=(t==null?void 0:t.map(st))??[]}catch(t){n.add({severity:"error",summary:t.response.data.error,life:2e3})}finally{A.value=!1}}Ae(async()=>{await G(),await fe(),await ee(Number(y.params.id)),T.value.length>0&&(v.value=[T.value[0].id])}),Ue([v,g],async()=>{v.value.length==0||g.value.length==0||await ve()});function he(){R.require({message:c("pages.teacher.areYouSureDeleteClass"),header:c("pages.teacher.confirmation"),icon:"pi pi-exclamation-triangle",rejectProps:{label:c("pages.teacher.cancel"),severity:"secondary",outlined:!0},acceptProps:{label:c("pages.teacher.delete"),severity:"danger"},accept:()=>{ye(Number(y.params.id))}})}async function ye(e){try{const{data:t}=await x.deleteClass(e);ue.go(-1),n.add({severity:"success",summary:t.message,life:2e3})}catch(t){n.add({severity:"error",summary:t.response.data.error,detail:t,life:2e3})}}function _e(e){R.require({message:c("pages.teacher.areYouSureExpelStudent"),header:c("pages.teacher.confirmation"),icon:"pi pi-exclamation-triangle",rejectProps:{label:c("pages.teacher.cancel"),severity:"secondary",outlined:!0},acceptProps:{label:c("pages.teacher.expel"),severity:"danger"},accept:()=>{be(e)}})}async function be(e){try{const{data:t}=await x.expelStudentFromClass(Number(y.params.id),e);await ee(Number(y.params.id)),n.add({severity:"success",summary:t.message,life:2e3})}catch(t){n.add({severity:"error",summary:t.response.data.error,detail:t,life:2e3})}}const z=u(!1),V=u(!1),F=u(null);async function $e(){if(F.value){z.value=!0;try{await x.assignTeacherToClass(Number(y.params.id),F.value.teacher_id),await G()}catch(e){console.log(e)}finally{z.value=!1,V.value=!1}}}function we(){R.require({message:c("pages.school.confirmDeleteTeacher"),header:c("pages.school.confirmHeader"),icon:"pi pi-exclamation-triangle",rejectProps:{label:c("pages.school.confirmCancel"),severity:"secondary",outlined:!0},acceptProps:{label:c("pages.school.confirmDeleteBtn"),severity:"danger"},accept:()=>{xe()}})}async function xe(){try{const{data:e}=await x.assignTeacherToClass(Number(y.params.id));await G(),n.add({severity:"success",summary:e.message,life:2e3})}catch(e){n.add({severity:"error",summary:e.response.data.error,detail:e,life:2e3})}}const U=u([]);async function Ce(){const{data:e}=await at.getTeachers();U.value=e??[]}return(e,t)=>{const a=He,m=Xe,_=Je,M=We,Se=Qe,p=Ye,E=rt,Te=nt,ke=Ke,te=Oe,Ie=De,Ve=Ne,q=Fe;return i(),w(Ve,{class:"flex-grow flex flex-col gap-2"},{default:r(()=>{var se,ae,oe,le,ne;return[l("div",it,[l("div",ut,[l("div",dt,[l("div",ct,d((se=C.value)==null?void 0:se.name),1),l("div",pt,d(e.$t("pages.teacher.since"))+" "+d((ae=C.value)==null?void 0:ae.createdTime),1)]),o(a,{icon:"pi pi-hashtag",label:e.$t("pages.teacher.classCode"),severity:"info",onClick:t[0]||(t[0]=s=>B.value=!0)},null,8,["label"])]),l("div",mt,[l("div",ft,[l("span",vt,d(e.$t("pages.teacher.teacher")),1),H(" "+d((oe=C.value)==null?void 0:oe.creatorName),1)]),((le=O(j))==null?void 0:le.user_type)=="school_manager"?(i(),w(a,{key:0,icon:"pi pi-pencil",severity:"info",variant:"text",rounded:"",onClick:t[1]||(t[1]=s=>V.value=!0)})):D("",!0),((ne=O(j))==null?void 0:ne.user_type)=="school_manager"?(i(),w(a,{key:1,icon:"pi pi-trash",severity:"danger",variant:"text",rounded:"",onClick:we})):D("",!0)]),o(ke,{ref_key:"dt",ref:de,filters:S.value,"onUpdate:filters":t[5]||(t[5]=s=>S.value=s),value:Z.value,dataKey:"id",loading:A.value,scrollable:"",globalFilterFields:["name","email"],class:"overflow-hidden w-full",paginator:"",rows:25,rowsPerPageOptions:[5,10,25],groupHeader:!0,showGridlines:""},{header:r(()=>[l("div",gt,[l("div",ht,[o(m,{class:"min-w-[220px]",options:T.value.map(s=>({label:s.name,value:s.id})),optionLabel:"label",invalid:v.value.length===0,optionValue:"value",display:"chip",modelValue:v.value,"onUpdate:modelValue":t[2]||(t[2]=s=>v.value=s),placeholder:e.$t("courses")},null,8,["options","invalid","modelValue","placeholder"]),o(m,{class:"min-w-[220px]",options:O(re),optionLabel:s=>s,optionValue:s=>s,display:"chip",modelValue:g.value,"onUpdate:modelValue":t[3]||(t[3]=s=>g.value=s),placeholder:e.$t("lessonType"),invalid:g.value.length===0},{option:r(({option:s})=>[l("div",yt,[l("div",_t,d(s.charAt(0).toUpperCase()+s.slice(1)),1),l("div",{class:Y(["w-3 h-3 rounded-full mx-auto",W(s)])},null,2)])]),_:1},8,["options","optionLabel","optionValue","modelValue","placeholder","invalid"])]),o(Se,null,{default:r(()=>[o(_,null,{default:r(()=>t[10]||(t[10]=[l("i",{class:"pi pi-search"},null,-1)])),_:1}),o(M,{modelValue:S.value.global.value,"onUpdate:modelValue":t[4]||(t[4]=s=>S.value.global.value=s),placeholder:e.$t("pages.teacher.search")},null,8,["modelValue","placeholder"])]),_:1})])]),empty:r(()=>[H(d(e.$t("pages.teacher.noStudentsFound")),1)]),loading:r(()=>[H(d(e.$t("pages.teacher.loadingStudents")),1)]),default:r(()=>[o(Te,{type:"header"},{default:r(()=>[o(E,null,{default:r(()=>[o(p,{header:e.$t("lessons"),rowspan:2,colspan:1,frozen:!0,alignFrozen:"left"},null,8,["header"]),(i(!0),f(b,null,L(k.value,s=>(i(),f(b,{key:s.id},[J.value[s.id]>0?(i(),w(p,{key:0,colspan:J.value[s.id]},{header:r(()=>[l("div",bt,d(s.name),1)]),_:2},1032,["colspan"])):D("",!0)],64))),128)),o(p,{header:"",rowspan:2,colspan:2})]),_:1}),o(E,null,{default:r(()=>[(i(!0),f(b,null,L(k.value,s=>(i(),f(b,{key:s.id},[(i(!0),f(b,null,L(s.levels,h=>(i(),f(b,{key:h.id},[Q.value[s.id][h.id]>0?(i(),w(p,{key:0,colspan:Q.value[s.id][h.id]},{header:r(()=>[l("div",$t,d(h.name),1)]),_:2},1032,["colspan"])):D("",!0)],64))),128))],64))),128))]),_:1}),o(E,null,{default:r(()=>[o(p,{header:e.$t("pages.teacher.name"),frozen:!0,alignFrozen:"left",sortable:"",field:"name"},null,8,["header"]),(i(!0),f(b,null,L(P.value,s=>(i(),w(p,{key:s.lessonId,field:s.lessonId.toString()},{header:r(()=>[K(l("div",{class:Y(["w-4 h-4 rounded-full mx-auto cursor-pointer",W(s.lessonType)])},null,2),[[q,{value:s.lessonName.toString()},void 0,{top:!0}]])]),_:2},1032,["field"]))),128)),o(p,{header:e.$t("pages.teacher.xp"),sortable:"",field:"xp",frozen:!0,alignFrozen:"right"},null,8,["header"]),o(p,{header:""})]),_:1})]),_:1}),o(p,{field:"name",sortable:"",frozen:!0,alignFrozen:"left"},{body:r(({data:s})=>[l("div",wt,[l("div",null,d(`${s.name.length>0?s.name:s.email}`),1),l("div",xt,d(`Last visited: ${s.lastActivityTime.toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}`),1)])]),_:1}),(i(!0),f(b,null,L(P.value,s=>(i(),w(p,{key:s.lessonId,field:s.lessonId.toString()},{body:r(({data:h})=>[K((i(),f("div",{class:Y(["w-4 h-4 p-1 rounded-full mx-auto flex items-center justify-center text-white",ge(I(h.id,s.lessonId))])},[I(h.id,s.lessonId)>=100?(i(),f("i",Ct)):I(h.id,s.lessonId)>0?(i(),f("i",St)):D("",!0)],2)),[[q,{value:I(h.id,s.lessonId).toString()+"%"},void 0,{top:!0}]])]),_:2},1032,["field"]))),128)),o(p,{field:"xp",frozen:!0,alignFrozen:"right"},{body:r(({data:s})=>[l("div",Tt,d(`${me(s.id)}/${pe.value}`),1)]),_:1}),o(p,{exportable:!1},{body:r(({data:s})=>[K(o(a,{icon:"pi pi-user-minus",rounded:"",variant:"text",severity:"danger",onClick:h=>_e(s.id)},null,8,["onClick"]),[[q,e.$t("pages.teacher.expelFromClass")]])]),_:1})]),_:1},8,["filters","value","loading"]),o(a,{icon:"pi pi-trash",label:e.$t("pages.teacher.removeClass"),severity:"danger",onClick:he,class:"self-end"},null,8,["label"])]),o(te,{visible:B.value,"onUpdate:visible":t[6]||(t[6]=s=>B.value=s),modal:"",header:e.$t("pages.teacher.classCode")},{default:r(()=>{var s;return[l("div",kt,d((s=C.value)==null?void 0:s.code),1)]}),_:1},8,["visible","header"]),o(te,{visible:V.value,"onUpdate:visible":t[9]||(t[9]=s=>V.value=s),modal:"",header:e.$t("pages.school.assignTeacher"),closable:!1},{default:r(()=>[l("div",It,[o(Ie,{modelValue:F.value,"onUpdate:modelValue":t[7]||(t[7]=s=>F.value=s),options:U.value,"option-label":"email",placeholder:e.$t("pages.school.selectTeacher")},null,8,["modelValue","options","placeholder"])]),l("div",Vt,[o(a,{type:"button",label:e.$t("pages.school.cancel"),severity:"secondary",onClick:t[8]||(t[8]=s=>V.value=!1)},null,8,["label"]),o(a,{type:"button",label:e.$t("pages.school.assign"),onClick:$e,loading:z.value,disabled:z.value},null,8,["label","loading","disabled"])])]),_:1},8,["visible","header"])]}),_:1})}}});export{ss as default};
